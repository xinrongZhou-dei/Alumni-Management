# 校友平台系统功能与接口文档

## 一、项目概览
- **后端**：Spring Boot 3.5 + MyBatis + MySQL + Redis，JWT 鉴权，拦截器统一校验，支持 WebSocket 依赖（暂未暴露接口）、二维码生成、阿里云 OSS 依赖（当前未见直接使用处）。
- **前端**：Vue 3 + Vite + Vue Router + Element Plus + Axios，ECharts 可视化，前端通过 `/api` 代理访问后端。
- **主要领域功能**：
  - 用户登录/找回密码/激活流程
  - 校友注册与信息管理、管理员批量管理
  - 标签管理
  - 分会与成员申请/审核
  - 活动管理、活动详情、报名与报名校验、二维码
  - 校园参观预约（校友端与管理员端）
  - 邮件模板管理与变量渲染
  - 权限管理（管理员与功能权限）、数据分析看板
  - 微信服务号：关注校验、二维码、模板消息发送

---

## 二、系统功能清单（已实现）

### 1. 账户与安全
- 登录：图形验证码校验（Redis 存储，单次有效），登录成功签发 JWT（12 小时），支持 Cookie `alumni-token` + Header `Authorization: Bearer`。
- 单点登录：Redis 维护 `sso:alumniId` 与 `token:*`，新登录会踢掉旧 token。
- 登出：清除 Redis 中 token 及 SSO 绑定，同时清除 Cookie。
- 忘记密码：三步（获取邮箱 token → 验证验证码 → 重置密码）。当前验证码为固定值 123456（测试用）。
- 激活流程：独立的激活页面序列与路由守卫，前端持有 `activate_token` 参与校验。
- 鉴权与拦截：`/api/**` 统一拦截，白名单放行登录、注册初始、忘记密码、激活、微信验证/二维码、验证码接口。拦截器支持 CORS 并暴露 `Authorization` 等头。

### 2. 校友注册与信息管理
- 邮箱验证、验证码校验、设置密码、完善个人信息。
- 管理端：新增校友、查询校友列表（分页、多条件）、删除校友（含教育与职业联动删除）。
- 个人信息获取：`/api/alumni/me` 返回当前登录校友详情。

### 3. 标签管理
- 标签列表、添加、删除（鉴权区分只读/读写权限）。

### 4. 分会管理
- 获取分会列表、我的分会。
- 创建分会、申请加入分会、获取分会申请列表、管理员审核分会申请。

### 5. 活动与报名
- 活动列表、详情、二维码生成（指向活动链接）。
- 活动新增、编辑、删除（需活动管理权限）。
- 报名：报名时间窗口校验、去重校验、乐观锁控制人数上限、报名成功推送微信模板消息。
- 查询个人报名、按活动查询报名列表（管理员）。
- 统计：进行中的报名活动数量。

### 6. 校园参观预约
- 校友端创建/更新预约。
- 管理端创建/查询列表/详情、更新状态、批量更新状态、按校友查询记录。
- 待审核数量统计。

### 7. 邮件模板
- 模板增删改查（列表不返 content 字段）。
- 固定/动态变量渲染，动态变量字段做白名单安全校验。

### 8. 权限与数据分析
- 管理员权限获取与管理员列表（分页、查询）。
- 数据分析看板：聚合统计接口。

### 9. 微信服务号相关
- 验证是否关注服务号。
- 生成临时二维码 URL。
- 绑定和更新 openid。
- 活动报名模板消息发送。

---

## 三、后端接口清单
说明：以下接口基于代码梳理，部分请求体字段较多，此处做提要，详见后端源码对应 `Controller` 与 `Service`。

### 1) 认证与账号（`/api`）
- POST `/api/login`：登录，参数：alumni_id, password, captchaCode, captchaUuid；返回 token、用户信息、并设置 Cookie。
- POST `/api/logout`：登出，清理 Redis token 与 cookie。
- PUT `/api/password`：修改密码（需登录）。
- POST `/api/forgot-password`：发起忘记密码（返回仅含邮箱的短期 token）。
- PUT `/api/forgot-password-verify`：校验验证码（测试用固定 123456），Header 需携带上一步返回的 Bearer token。
- PUT `/api/forgot-password-put`：提交新密码。
- GET `/api/check-auth`：检查登录状态与解析用户信息。
- GET `/api/alumni/me`：获取当前登录校友详情。

### 2) 注册流程（`/api/register`）
- POST `/api/register/verify-email`：发送邮箱验证码。
- POST `/api/register/verify`：校验邮箱验证码（需 Authorization）。
- POST `/api/register/set-password`：设置密码（需 Authorization）。
- PUT `/api/register/alumni-detail`：完善校友信息（需登录）。
- GET `/api/alumni-list`：查询校友列表（多条件、分页）。
- DELETE `/api/alumni-list`：批量删除校友。
- POST `/api/alumni-add`：管理员新增校友。

提示：代码中还包含如下接口（若前端未直接使用，仍为可用能力）：
- GET `/api/register/get-alumni-id`：生成/获取唯一学号（见 `RegisterController`）。

### 3) 标签（`/api/tag`）
- GET `/api/tag/list`：标签列表（分页，需标签只读权限）。
- POST `/api/tag/add`：新增标签（需读写权限）。
- DELETE `/api/tag/delete`：删除标签（需读写权限）。

### 4) 分会（`/api/chapters`）
- GET `/api/chapters`：获取分会列表。
- POST `/api/chapters`：创建分会。
- GET `/api/chapters/my`：获取我的分会。
- [其余如申请/审核/列表接口在 `ChapterController` 中，包含：分会申请列表、我的申请、管理员审核等。]

### 5) 活动（`/api/activity`）
- GET `/api/activity/list`：活动列表（登录必需；管理员访问会校验活动权限）。
- GET `/api/activity/detail/{uuid}`：活动详情。
- GET `/api/activity/qrcode/{uuid}`：活动二维码图片输出。
- GET `/api/activity/ongoing-signup-count`：进行中报名活动数量。
- POST `/api/activity/add`：新增活动（需读写权限）。
- PUT `/api/activity/edit/{uuid}`：编辑活动（需读写权限）。
- DELETE `/api/activity/delete/{uuid}`：删除活动（需读写权限）。

### 6) 活动报名（`/api/activity`）
- POST `/api/activity/signup`：报名（含时间窗口/人数上限/重复报名校验，成功触发微信通知）。
- GET `/api/activity/registration`：查询个人报名信息。
- GET `/api/activity/registrations`：按活动查询报名列表（需活动只读权限）。

### 7) 校园参观预约（`/api/visitrecord`）
- POST `/api/visitrecord/alumni/visit-records`：校友创建预约（需登录）。
- PUT `/api/visitrecord/alumni/visit-records/{visitUUID}`：校友更新预约。
- POST `/api/visitrecord/admin/visit-records`：管理员创建预约。
- GET `/api/visitrecord/admin/visit-records`：管理员获取预约列表。
- GET `/api/visitrecord/admin/visit-records/{visitUUID}`：预约详情。
- PUT `/api/visitrecord/admin/visit-records/status`：更新预约状态。
- PUT `/api/visitrecord/admin/visit-records/batch-status`：批量更新状态。
- GET `/api/visitrecord/admin/visit-records/alumni`：按校友查询预约。
- GET `/api/visitrecord/pending-visit-record-count`：待审核数量。

### 8) 邮件模板（`/api/email-template`）
- GET `/api/email-template/list`：模板列表（按 `targetType`）。
- POST `/api/email-template`：新增模板。
- PUT `/api/email-template/{id}`：编辑模板。
- DELETE `/api/email-template/{id}`：删除模板。
- POST `/api/email-template/variables`：固定变量渲染。
- POST `/api/email-template/variables-dynamic`：动态变量渲染（字段白名单安全校验）。

### 9) 权限、数据分析与管理员（`/api/admin`、`/api/permissions`、`/api`）
- GET `/api/admin/permissions`：获取当前管理员功能权限。
- GET `/api/permissions/admins`：管理员列表（分页/查询，需权限管理只读权限）。
- POST `/api/permissions/admins`：新增管理员（见 `PermissionController`）。
- GET `/api/admin/data-analysis`：数据分析统计（见 `DataAnalysisController`）。

### 10) 微信服务号（`/api/wechat`）
- POST `/api/wechat/verify-follow`：校验是否关注服务号。
- GET `/api/wechat/qrcode/{alumniId}`：生成临时二维码 URL。
- POST `/api/wechat/update-openid`：更新绑定 openid。
- POST `/api/wechat/message/send`：发送模板消息（见 `WeChatMessageController`）。

### 11) 其他
- GET `/api/captcha`：获取图形验证码（见 `CaptchaController`）。
- 文件上传相关：`UploadController` 已存在（请参考源码确认具体路径与权限）。

---

## 四、前端主要页面与路由
见 `frontend/src/router/index.js`：
- 首页/仪表盘：`/` → `AlumniMain`
- 登录：`/login`
- 注册流程：`/alumni/register` → `/alumni/register/verify` → `/alumni/register/set-password` → `/alumni/register/submit-info`
- 忘记/修改密码：`/alumni/forgot-password`，`/alumni/change-password`
- 校友详情/编辑：`/alumni/detail/:id`，`/alumni/edit`（本人），`/alumni/edit/:id`（管理员）
- 校友管理：`/alumni/manage`，`/admin/alumni-add`
- 标签管理：`/admin/tag-manage`
- 校友搜索：`/alumni/search`
- 分会成员与审核：`/alumni/chapter-members/:chapterId`，`/admin/chapter-review`
- 活动：`/admin/activity-manage`，`/admin/activity-detail/:id`，`/admin/activity-edit/:id`，`/admin/activity-add`，`/alumni/activity-detail/:id`，`/alumni/activity-signup`
- 邮件模板：`/admin/email-template-manage`，`/admin/email-template-add`，`/admin/email-send`，`/email/send`
- 参观预约：`/admin/visit-records`，`/admin/visit-records/:id`，`/visit-record/form`，`/alumni/visit-records`
- 数据分析：`/admin/data-analysis`
- 权限管理：`/admin/permission-manage`
- 激活流程：`/alumni/activate` → `/alumni/activate/set-password` → `/alumni/activate/set-email` → `/alumni/activate/success`

前端全局守卫：
- 白名单放行登录、注册、激活等；其余路由需登录（`sessionStorage.user_info`）。
- 管理员路由前置校验 `user.role === 'admin'`。
- 激活相关路由对 `activate_token` 有时效校验。

---

## 五、运行与配置

### 1) 环境需求
- JDK 17+
- Node.js 18+（建议）
- MySQL 8+
- Redis 6+

### 2) 数据库配置（后端 `application.properties`）
```properties
spring.datasource.url=jdbc:mysql://localhost:3306/alumni?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai
spring.datasource.username=YOUR_USERNAME
spring.datasource.password=YOUR_PASSWORD
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

mybatis.type-aliases-package=com.alumni.back.Entity
mybatis.mapper-locations=classpath:mapper/*.xml
mybatis.configuration.map-underscore-to-camel-case=true
```

请将数据库账号密码替换为实际值。并导入对应表结构与 `mapper/*.xml` 所需的表（表结构请根据 `Entity` 与 `mapper` 文件准备）。

### 3) Redis 配置
```properties
spring.data.redis.host=YOUR_REDIS_HOST
spring.data.redis.port=6379
spring.data.redis.password=YOUR_REDIS_PASSWORD
spring.data.redis.timeout=5000
```
Redis 用于：登录验证码、登录 token、SSO 校验。

### 4) 微信服务号与上传相关
```properties
wechat.appId=YOUR_APP_ID
wechat.secret=YOUR_SECRET
wechat.template.activity-signup=模板ID
wechat.template.chapter-review-success=模板ID
wechat.template.campus-visit-success=模板ID
wechat.template.create-chapter-admin=模板ID

spring.servlet.multipart.max-file-size=20MB
spring.servlet.multipart.max-request-size=20MB
```
- 模板 ID 需在微信公众平台申请并替换。
- 若使用 OSS，请在 `pom.xml` 中依赖已添加，具体配置按实际接入编写（当前代码未直接读取 OSS AccessKey 配置）。

### 5) 端口与代理
- 后端：默认 `server.port=8080`
- 前端：Vite 开发端口 `5173`，并配置代理：
```js
proxy: {
  '/api': { target: 'http://localhost:8080', changeOrigin: true, secure: false, ws: true }
}
```
- 允许的开发主机：`vite.config.js` 中 `allowedHosts` 已添加若干域名，如需外网映射请按需增删。

### 6) CORS 与鉴权
- `WebConfig` 开启全路径 CORS，允许所有源、常用方法与头，并暴露 `Authorization`。
- `AuthInterceptor`：
  - 路由白名单：`/api/login`, `/api/register/*`（部分），`/api/forgot-password*`, `/api/activate/**`, `/api/wechat/*`, `/api/captcha`。
  - Token 校验顺序：Header Bearer → Cookie `alumni-token`。
  - Redis 校验：`token:*` 与 `sso:*`。
  - 管理员路径片段额外做角色校验（如 `/api/activity/add|edit|delete`、`/api/tag/*` 等）。

---

## 六、本地启动步骤

### 后端
1. 准备好 MySQL 与 Redis，按“运行与配置”修改 `application.properties`。
2. 在 `back/` 目录：
   - Windows: `mvnw.cmd spring-boot:run`
   - macOS/Linux: `./mvnw spring-boot:run`
   - 或打包运行：`./mvnw clean package` 后执行 `java -jar target/back-0.0.1-SNAPSHOT.jar`

### 前端
1. 在 `frontend/` 目录执行：
   - 安装依赖：`npm install`
   - 开发启动：`npm run dev`（默认 `http://localhost:5173`）
   - 生产构建：`npm run build`，产物在 `frontend/dist/`

### 访问
- 浏览器访问前端地址（开发环境）：`http://localhost:5173`
- 前端通过 `/api` 代理访问后端，无需改动代码。

---

## 七、部署建议
- 后端：使用外部化配置（如环境变量或 `--spring.config.additional-location`），不要在仓库存储敏感信息（数据库、Redis、微信密钥）。
- 前端：`dist/` 静态资源可部署到 Nginx/静态服务，反向代理 `/api` 到后端。
- HTTPS：生产建议开启 HTTPS；后端设置的 Cookie `secure=true` 需在 HTTPS 下生效。
- 日志与监控：建议增加统一日志、错误告警与接口审计。

---

## 八、注意事项与安全
- 替换 `application.properties` 中的示例敏感信息；提交到 GitHub 前务必清理真实密钥与密码。
- 忘记密码验证码目前为固定值 123456（测试用），上线前必须接入真实邮件/短信校验。
- 管理员敏感接口已在拦截器与 `PermissionUtil` 双重校验，仍需前端隐藏入口并做好异常处理。
- 依赖与版本：见 `back/pom.xml` 与 `frontend/package.json`，建议使用锁定版本构建。

---

## 九、附录：关键文件位置
- 后端配置：`back/src/main/resources/application.properties`
- 鉴权拦截：`back/src/main/java/com/alumni/back/config/AuthInterceptor.java`
- CORS/拦截注册：`back/src/main/java/com/alumni/back/config/WebConfig.java`
- 登录与账号：`back/src/main/java/com/alumni/back/LoginController.java`
- 注册：`back/src/main/java/com/alumni/back/register/RegisterController.java`
- 活动：`back/src/main/java/com/alumni/back/activity/ActivityController.java`
- 报名：`back/src/main/java/com/alumni/back/activity/ActivityRegistrationController.java`
- 参观预约：`back/src/main/java/com/alumni/back/visitrecord/VisitRecordController.java`
- 邮件模板：`back/src/main/java/com/alumni/back/emailtemplate/EmailTemplateController.java`
- 分会：`back/src/main/java/com/alumni/back/chapter/ChapterController.java`
- 标签：`back/src/main/java/com/alumni/back/tag/TagController.java`
- 权限：`back/src/main/java/com/alumni/back/permission/PermissionController.java`
- 数据分析：`back/src/main/java/com/alumni/back/dataanalysis/DataAnalysisController.java`
- 微信服务号：`back/src/main/java/com/alumni/back/wechat/WeChatMessageController.java`
- 前端路由：`frontend/src/router/index.js`
- 前端请求封装：`frontend/src/utils/request.js`
- 前端开发代理：`frontend/vite.config.js`



