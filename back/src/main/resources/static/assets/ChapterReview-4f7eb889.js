import{_ as Ce,a as De,r as u,c as y,o as xe,A as Ee,d as v,a3 as Ie,e as g,f as $,g as a,w as n,q,k as h,a5 as Y,p as C,t as _,b as I,z as d,W as ke,D as Se,h as Pe,i as Re,j as p,l as L,F as Ae,m as Ve}from"./index-fee6fb78.js";const ze={class:"chapter-review-root"},Ne={class:"action-buttons"},Te={class:"operation-btns"},Be={class:"pagination-info"},je={class:"application-section"},Me={class:"search-area"},Le={class:"pagination-info"},z=20,N=20,Oe={__name:"ChapterReview",setup(We){const H=De(),w=u([]),T=u(!1),b=u([]),O=u([]),B=u(!1),W=u([]),D=u(1),m=u(0),s=u(window.innerWidth<=768);window.addEventListener("resize",()=>{s.value=window.innerWidth<=768});const r=u({chapterId:"",status:"",alumniId:""}),k=u(null),K=e=>({pending:"待审核",approved:"已批准",rejected:"已拒绝"})[e]||e,Q=e=>({pending:"warning",approved:"success",rejected:"danger"})[e]||"info",j=e=>{if(!e)return"";const t=new Date(e);return t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,"0")+"-"+String(t.getDate()).padStart(2,"0")},f=async()=>{try{const e=await I.get("/api/admin/permissions");if(e.data.code===0){const t=e.data.data;m.value=t.chapter_review_permission||0}else m.value=0}catch{m.value=0}},F=async()=>{T.value=!0;try{await f();const e=await I.get("/api/chapters/review-list");w.value=e.data.data||[]}catch{d.error("获取分会审核列表失败")}finally{T.value=!1}},X=e=>{b.value=e},S=u(null),Z=async()=>{S.value&&S.value.clearSelection();const e=w.value.filter(t=>t.status==="pending");await ke(),e.forEach(t=>{S.value.toggleRowSelection(t,!0)}),b.value=e,d.success(`已选中 ${e.length} 条待审核数据`)},ee=async e=>{if(await f(),m.value!==2){d.warning("权限不足，无法进行操作");return}await P([e.tag_id],"approved")},te=async e=>{if(await f(),m.value!==2){d.warning("权限不足，无法进行操作");return}await P([e.tag_id],"rejected")},ae=async()=>{if(await f(),m.value!==2){d.warning("权限不足，无法进行操作");return}await P(b.value.map(e=>e.tag_id),"approved")},le=async()=>{if(await f(),m.value!==2){d.warning("权限不足，无法进行操作");return}await P(b.value.map(e=>e.tag_id),"rejected")},P=async(e,t)=>{try{if(await f(),m.value!==2){d.warning("权限不足，无法进行操作");return}await I.post("/api/chapters/review-status",{tagIds:e,status:t}),d.success("操作成功"),F()}catch{d.error("操作失败")}},ne=()=>{H.push("../")};function se(){k.value=Se({onMessage:e=>{const t=e.data;["chapter changed","alumni changed"].includes(t)&&getChapters()},onClose:()=>{}})}const ie=async()=>{B.value=!0;try{const e=await I.get("/api/chapters/applications");O.value=e.data.data||[]}catch{d.error("获取申请列表失败")}finally{B.value=!1}},oe=async()=>{try{const e=await I.get("/api/chapters");e.data.success?W.value=e.data.data||[]:d.error(e.data.msg||"获取分会列表失败")}catch(e){console.error("获取所有分会失败",e),d.error("获取分会列表失败")}},x=y(()=>{let e=[...O.value];if(r.value.chapterId&&(e=e.filter(c=>c.tag_id===r.value.chapterId)),r.value.status&&(e=e.filter(c=>c.status===r.value.status)),r.value.alumniId){const c=r.value.alumniId.toLowerCase();e=e.filter(o=>o.alumni_id&&o.alumni_id.toLowerCase().includes(c))}const t={PENDING:1,REJECTED:2,APPROVED:3};return e.sort((c,o)=>{const i=t[c.status]-t[o.status];if(i!==0)return i;const R=new Date(c.review_time||c.apply_time||0);return new Date(o.review_time||o.apply_time||0)-R}),e}),re=e=>({PENDING:"warning",APPROVED:"success",REJECTED:"danger"})[e]||"info",ue=e=>({PENDING:"待审核",APPROVED:"已通过",REJECTED:"已拒绝"})[e]||e,ce=()=>{r.value={chapterId:"",status:"",alumniId:""}},de=y(()=>{const e=(D.value-1)*z,t=e+z;return w.value.slice(e,t)}),pe=y(()=>w.value.length===0?0:(D.value-1)*z+1),ve=y(()=>Math.min(D.value*z,w.value.length));function _e(e){D.value=e}const E=u(1),me=y(()=>{const e=(E.value-1)*N,t=e+N;return x.value.slice(e,t)}),ge=y(()=>x.value.length===0?0:(E.value-1)*N+1),he=y(()=>Math.min(E.value*N,x.value.length));function we(e){E.value=e}return xe(()=>{f(),F(),ie(),oe(),se()}),Ee(()=>{k.value&&k.value._manualClose&&k.value._manualClose()}),(e,t)=>{const c=v("el-icon"),o=v("el-button"),i=v("el-table-column"),R=v("el-tag"),M=v("el-table"),G=v("el-pagination"),A=v("el-option"),J=v("el-select"),V=v("el-col"),fe=v("el-input"),ye=v("el-row"),U=Ie("loading");return g(),$("div",ze,[a(o,{class:"back-btn",type:"text",onClick:ne,style:q(s.value?"position: static; margin-bottom: 16px;":"position: absolute; left: 16px; top: 16px; z-index: 10;")},{default:n(()=>[a(c,{style:{"vertical-align":"middle","margin-right":"4px"}},{default:n(()=>[a(Pe(Re))]),_:1}),t[3]||(t[3]=p("返回 "))]),_:1,__:[3]},8,["style"]),h("div",{class:"chapter-review-title",style:q(s.value?"":"padding-left: 80px;")},"分会审核",4),h("div",Ne,[a(o,{type:"primary",onClick:Z,class:"action-btn"},{default:n(()=>t[4]||(t[4]=[p("全选待审核")])),_:1,__:[4]}),a(o,{type:"success",disabled:b.value.length===0,onClick:ae,class:"action-btn"},{default:n(()=>t[5]||(t[5]=[p("批量批准")])),_:1,__:[5]},8,["disabled"]),a(o,{type:"danger",disabled:b.value.length===0,onClick:le,class:"action-btn"},{default:n(()=>t[6]||(t[6]=[p("批量拒绝")])),_:1,__:[6]},8,["disabled"])]),Y((g(),C(M,{ref_key:"tableRef",ref:S,data:de.value,border:"",style:{width:"100%"},onSelectionChange:X,size:s.value?"small":"default"},{default:n(()=>[a(i,{type:"selection",width:"55"}),a(i,{prop:"branch_name",label:"分会名称",width:s.value?"":"180"},null,8,["width"]),a(i,{prop:"creator_name",label:"创建人姓名",width:s.value?"":"120"},null,8,["width"]),a(i,{prop:"alumni_id",label:"创建人学号",width:s.value?"":"120"},null,8,["width"]),a(i,{prop:"create_time",label:"创建时间",width:s.value?"":"150"},{default:n(l=>[p(_(j(l.row.create_time)),1)]),_:1},8,["width"]),a(i,{prop:"status",label:"审核状态",width:s.value?"":"100"},{default:n(l=>[a(R,{type:Q(l.row.status)},{default:n(()=>[p(_(K(l.row.status)),1)]),_:2},1032,["type"])]),_:1},8,["width"]),m.value===2?(g(),C(i,{key:0,label:"操作",width:s.value?"":"180"},{default:n(l=>[h("div",Te,[l.row.status==="pending"?(g(),C(o,{key:0,type:"success",size:"small",onClick:be=>ee(l.row)},{default:n(()=>t[7]||(t[7]=[p("批准")])),_:2,__:[7]},1032,["onClick"])):L("",!0),l.row.status==="pending"?(g(),C(o,{key:1,type:"danger",size:"small",onClick:be=>te(l.row)},{default:n(()=>t[8]||(t[8]=[p("拒绝")])),_:2,__:[8]},1032,["onClick"])):L("",!0)])]),_:1},8,["width"])):L("",!0)]),_:1},8,["data","size"])),[[U,T.value]]),a(G,{"current-page":D.value,"page-size":20,total:w.value.length,layout:(s.value,"prev, pager, next"),onCurrentChange:_e,"page-sizes":[20],disabled:!0,class:"pagination"},null,8,["current-page","total","layout"]),h("div",Be," 当前第"+_(pe.value)+"到"+_(ve.value)+"条，共"+_(w.value.length)+"条 ",1),h("div",je,[t[10]||(t[10]=h("div",{class:"section-title"},"申请加入分会",-1)),h("div",Me,[a(ye,{gutter:16},{default:n(()=>[a(V,{xs:24,sm:24,md:8,lg:6,class:"search-item"},{default:n(()=>[a(J,{modelValue:r.value.chapterId,"onUpdate:modelValue":t[0]||(t[0]=l=>r.value.chapterId=l),placeholder:"选择分会",clearable:"",style:{width:"100%"}},{default:n(()=>[(g(!0),$(Ae,null,Ve(W.value,l=>(g(),C(A,{key:l.tagId,label:l.branchName,value:l.tagId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(V,{xs:24,sm:24,md:8,lg:6,class:"search-item"},{default:n(()=>[a(J,{modelValue:r.value.status,"onUpdate:modelValue":t[1]||(t[1]=l=>r.value.status=l),placeholder:"申请状态",clearable:"",style:{width:"100%"}},{default:n(()=>[a(A,{label:"待审核",value:"PENDING"}),a(A,{label:"已通过",value:"APPROVED"}),a(A,{label:"已拒绝",value:"REJECTED"})]),_:1},8,["modelValue"])]),_:1}),a(V,{xs:24,sm:24,md:8,lg:6,class:"search-item"},{default:n(()=>[a(fe,{modelValue:r.value.alumniId,"onUpdate:modelValue":t[2]||(t[2]=l=>r.value.alumniId=l),placeholder:"申请人学号",clearable:"",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(V,{xs:24,sm:24,md:8,lg:6,class:"search-item"},{default:n(()=>[a(o,{onClick:ce},{default:n(()=>t[9]||(t[9]=[p("重置")])),_:1,__:[9]})]),_:1})]),_:1})]),Y((g(),C(M,{data:me.value,border:"",style:{width:"100%"},size:s.value?"small":"default"},{default:n(()=>[a(i,{prop:"branch_name",label:"分会名称",width:s.value?"":"180"},null,8,["width"]),a(i,{prop:"applicant_name",label:"申请人",width:s.value?"":"120"},null,8,["width"]),a(i,{prop:"alumni_id",label:"申请人学号",width:s.value?"":"120"},null,8,["width"]),a(i,{prop:"status",label:"申请状态",width:s.value?"":"100"},{default:n(l=>[a(R,{type:re(l.row.status)},{default:n(()=>[p(_(ue(l.row.status)),1)]),_:2},1032,["type"])]),_:1},8,["width"]),a(i,{prop:"apply_time",label:"申请时间",width:s.value?"":"180"},{default:n(l=>[p(_(j(l.row.apply_time)),1)]),_:1},8,["width"]),a(i,{prop:"review_time",label:"审核时间",width:s.value?"":"180"},{default:n(l=>[p(_(j(l.row.review_time)),1)]),_:1},8,["width"])]),_:1},8,["data","size"])),[[U,B.value]]),a(G,{"current-page":E.value,"page-size":20,total:x.value.length,layout:(s.value,"prev, pager, next"),onCurrentChange:we,"page-sizes":[20],disabled:!0,class:"pagination"},null,8,["current-page","total","layout"]),h("div",Le," 当前第"+_(ge.value)+"到"+_(he.value)+"条，共"+_(x.value.length)+"条 ",1)])])}}},Ge=Ce(Oe,[["__scopeId","data-v-bb778541"]]);export{Ge as default};
