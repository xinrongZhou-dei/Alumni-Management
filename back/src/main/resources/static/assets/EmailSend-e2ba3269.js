import{_ as Se,a as ke,u as Ve,r as o,K as Ie,c as le,o as Ce,d,e as r,f as c,g as a,w as s,q as xe,k as l,j as u,t as m,l as h,F as H,m as Q,p as E,N as Ne,z as k,h as Te,i as ze,n as Ae}from"./index-fee6fb78.js";import{g as Le,u as Ee,b as Ue,c as Pe}from"./emailTemplate-8aa76c0b.js";const je={class:"email-send"},Be={key:0,class:"step-content"},Fe={class:"search-section"},qe={class:"alumni-list"},De={class:"pagination"},Me={class:"selected-info"},Oe={key:1,class:"step-content"},Re={key:2,class:"step-content"},Je={key:0,class:"loading"},We={key:1,class:"preview-content"},Ke={class:"preview-summary"},$e={class:"preview-header"},Ge={key:0},He={key:1},Qe={class:"email-preview"},Xe={class:"email-header"},Ye={class:"email-body"},Ze={class:"email-content"},el={key:3,class:"step-content"},ll={class:"send-confirmation"},tl={class:"step-actions"},al={class:"action-row"},nl={__name:"EmailSend",setup(sl){const D=ke(),X=Ve(),v=o(window.innerWidth<=768);window.addEventListener("resize",()=>{v.value=window.innerWidth<=768});const p=o(0),te=o(0),M=o(0),y=o({name:"",email:"",schools:[]}),V=o([]),w=o([]),I=o(1),U=o(20),P=o(0);let O=null;const R=()=>{O&&clearTimeout(O),O=setTimeout(()=>{N()},500)};Ie([()=>y.value.name,()=>y.value.email],()=>{R()});const b=o({targetType:"alumni",templateId:""}),J=o([]),i=o(null),W=o(!1),K=o([]),j=o(!1),$=o([]),B=o(""),C=o(""),x=o(""),ae=le(()=>{switch(p.value){case 0:return w.value.length>0;case 1:return i.value!==null;case 2:return K.value.length>0;default:return!0}}),F=le(()=>{var n;return/{{\s*activity\./.test(((n=i.value)==null?void 0:n.content)||"")}),N=async()=>{try{const n=JSON.parse(localStorage.getItem("admin_permissions")||"{}"),e={name:y.value.name,email:y.value.email,pageNum:I.value,pageSize:U.value,permissionSchool:n.accessible_schools||"",alumniInfoManagementPermission:n.alumni_info_management_permission||0},_=await Ne(e);_.data.code===0?(V.value=_.data.data||[],P.value=_.data.total||0):(k.error(_.data.msg||"搜索校友失败"),V.value=[],P.value=0)}catch{k.error("搜索校友失败"),V.value=[],P.value=0}},ne=()=>{y.value={name:"",email:"",schools:[]},I.value=1,N()},se=n=>{w.value=n.map(e=>e.alumniId)},oe=n=>{U.value=n,I.value=1,N()},ue=n=>{I.value=n,N()},Y=async()=>{try{const n=await Le(b.value.targetType);J.value=n.data,b.value.templateId="",i.value=null}catch{k.error("加载模板失败")}},ie=()=>{i.value=J.value.find(n=>n.id===b.value.templateId)},re=async()=>{try{const n=await Pe();$.value=n.data&&n.data.data?n.data.data:[]}catch{$.value=[]}},de=()=>{ie(),i.value&&(C.value=i.value.theme,x.value=i.value.content),F.value&&re()};function me(n){const e=[...n.matchAll(/{{(.*?)}}/g)];return[...new Set(e.map(_=>_[1].trim()))]}const ce=async()=>{if(!(!i.value||w.value.length===0)){if(F.value&&!B.value){k.warning("请选择活动！");return}W.value=!0;try{const n=me(i.value.content),e={alumniIds:w.value,fields:n,templateContent:i.value.content};F.value&&(e.activityUuid=B.value);const _=await Ue(e);K.value=_.data.map(f=>{const g=V.value.find(S=>S.alumniId===f.alumniId)||{};let T=i.value.content;return Object.entries(f.variables).forEach(([S,z])=>{T=T.replace(new RegExp(`{{${S}}}`,"g"),z||"")}),{alumniId:f.alumniId,chineseName:g.chineseName,firstName:g.firstName,lastName:g.lastName,email:g.email,ycywSchoolsAttended:g.ycywSchoolsAttended,yearLeft:g.yearLeft,subject:i.value.theme,content:T}})}catch{k.error("生成预览失败")}finally{W.value=!1}}},ve=async()=>{j.value=!0;try{await new Promise(n=>setTimeout(n,2e3)),k.success("邮件发送成功"),X.query.from==="review"?D.push("/alumni/review"):D.back()}catch{k.error("邮件发送失败")}finally{j.value=!1}},pe=async()=>{p.value===1&&(i.value&&(await Ee(i.value.id,{...i.value,theme:C.value,content:x.value}),i.value.theme=C.value,i.value.content=x.value),await ce()),p.value++},_e=()=>{p.value--},fe=()=>{D.back()};return Ce(async()=>{const n=JSON.parse(localStorage.getItem("admin_permissions")||"{}");te.value=n.alumni_info_management_permission||0,M.value=n.email_template_permission||0,M.value===1&&(b.value.targetType="alumni"),await N(),await Y();const e=X.query.alumniId;e&&V.value.find(f=>f.alumniId===e)&&(w.value=[e],p.value=1)}),(n,e)=>{var Z;const _=d("el-icon"),f=d("el-button"),g=d("el-step"),T=d("el-steps"),S=d("el-input"),z=d("el-col"),ge=d("el-row"),A=d("el-table-column"),ye=d("el-table"),be=d("el-pagination"),q=d("el-option"),G=d("el-select"),L=d("el-form-item"),he=d("el-form"),we=d("el-loading");return r(),c("div",je,[a(f,{type:"text",onClick:fe,class:"back-btn",style:xe(v.value?"position: static; margin-bottom: 16px;":"")},{default:s(()=>[a(_,{style:{"vertical-align":"middle","margin-right":"4px"}},{default:s(()=>[a(Te(ze))]),_:1}),e[9]||(e[9]=u("返回 "))]),_:1,__:[9]},8,["style"]),a(T,{active:p.value,"finish-status":"success",direction:v.value?"vertical":"horizontal",class:"email-steps"},{default:s(()=>[a(g,{title:"选择校友"}),a(g,{title:"选择模板"}),a(g,{title:"预览内容"}),a(g,{title:"发送邮件"})]),_:1},8,["active","direction"]),p.value===0?(r(),c("div",Be,[e[13]||(e[13]=l("h3",null,"选择收件人",-1)),l("div",Fe,[a(ge,{gutter:v.value?0:10},{default:s(()=>[a(z,{xs:24,sm:12,md:8,lg:8,class:"search-item"},{default:s(()=>[a(S,{modelValue:y.value.name,"onUpdate:modelValue":e[0]||(e[0]=t=>y.value.name=t),placeholder:"搜索校友姓名",class:"search-input",onInput:R,clearable:""},null,8,["modelValue"])]),_:1}),a(z,{xs:24,sm:12,md:8,lg:8,class:"search-item"},{default:s(()=>[a(S,{modelValue:y.value.email,"onUpdate:modelValue":e[1]||(e[1]=t=>y.value.email=t),placeholder:"搜索邮箱",class:"search-input",onInput:R,clearable:""},null,8,["modelValue"])]),_:1}),a(z,{xs:24,sm:24,md:8,lg:8,class:"search-item clear-btn-col"},{default:s(()=>[a(f,{onClick:ne,class:"clear-btn"},{default:s(()=>e[10]||(e[10]=[u("清空")])),_:1,__:[10]})]),_:1})]),_:1},8,["gutter"])]),l("div",qe,[a(ye,{data:V.value,onSelectionChange:se,style:{width:"100%"},size:v.value?"small":"default"},{default:s(()=>[a(A,{type:"selection",width:"55"}),a(A,{prop:"chineseName",label:"中文姓名"}),a(A,{prop:"email",label:"邮箱"}),a(A,{prop:"ycywSchoolsAttended",label:"就读学校","show-overflow-tooltip":!0}),a(A,{prop:"yearLeft",label:"毕业年份",width:v.value?"":"100"},null,8,["width"])]),_:1},8,["data","size"]),l("div",De,[a(be,{"current-page":I.value,"onUpdate:currentPage":e[2]||(e[2]=t=>I.value=t),"page-size":U.value,"onUpdate:pageSize":e[3]||(e[3]=t=>U.value=t),"page-sizes":[10,20,50,100],total:P.value,layout:v.value?"prev, pager, next":"total, sizes, prev, pager, next, jumper",onSizeChange:oe,onCurrentChange:ue,small:v.value},null,8,["current-page","page-size","total","layout","small"])])]),l("div",Me,[l("p",null,[e[11]||(e[11]=u("已选择 ")),l("strong",null,m(w.value.length),1),e[12]||(e[12]=u(" 位校友"))])])])):h("",!0),p.value===1?(r(),c("div",Oe,[e[14]||(e[14]=l("h3",null,"选择邮件模板",-1)),a(he,{model:b.value,"label-width":v.value?"70px":"100px","label-position":v.value?"top":"right"},{default:s(()=>[a(L,{label:"目标对象"},{default:s(()=>[a(G,{modelValue:b.value.targetType,"onUpdate:modelValue":e[4]||(e[4]=t=>b.value.targetType=t),onChange:Y,disabled:M.value===1,style:{width:"100%"}},{default:s(()=>[a(q,{label:"校友",value:"alumni"}),a(q,{label:"管理员",value:"admin"})]),_:1},8,["modelValue","disabled"])]),_:1}),a(L,{label:"邮件模板"},{default:s(()=>[a(G,{modelValue:b.value.templateId,"onUpdate:modelValue":e[5]||(e[5]=t=>b.value.templateId=t),onChange:de,style:{width:"100%"}},{default:s(()=>[(r(!0),c(H,null,Q(J.value,t=>(r(),E(q,{key:t.id,label:t.templateName,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),F.value?(r(),E(L,{key:0,label:"选择活动"},{default:s(()=>[a(G,{modelValue:B.value,"onUpdate:modelValue":e[6]||(e[6]=t=>B.value=t),placeholder:"请选择活动",style:{width:"100%"}},{default:s(()=>[(r(!0),c(H,null,Q($.value,t=>(r(),E(q,{key:t.uuid,label:(t.name||"无名称")+"（"+(t.activityDate||"无日期")+"）",value:t.uuid},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):h("",!0),a(L,{label:"主题"},{default:s(()=>[a(S,{modelValue:C.value,"onUpdate:modelValue":e[7]||(e[7]=t=>C.value=t),placeholder:"请输入邮件主题"},null,8,["modelValue"])]),_:1}),a(L,{label:"内容"},{default:s(()=>[a(S,{type:"textarea",modelValue:x.value,"onUpdate:modelValue":e[8]||(e[8]=t=>x.value=t),rows:v.value?6:10,placeholder:"请输入邮件内容，可插入变量"},null,8,["modelValue","rows"])]),_:1})]),_:1},8,["model","label-width","label-position"])])):h("",!0),p.value===2?(r(),c("div",Re,[e[26]||(e[26]=l("h3",null,"预览邮件内容",-1)),W.value?(r(),c("div",Je,[a(we,{fullscreen:!1}),e[15]||(e[15]=l("p",null,"正在生成预览内容...",-1))])):(r(),c("div",We,[l("div",Ke,[l("p",null,[e[16]||(e[16]=u("共选择 ")),l("strong",null,m(w.value.length),1),e[17]||(e[17]=u(" 位校友，以下是每位的个性化邮件内容："))])]),(r(!0),c(H,null,Q(K.value,(t,ee)=>(r(),c("div",{key:ee,class:"preview-item"},[l("div",$e,[l("h4",null,"第 "+m(ee+1)+" 位校友",1),l("div",{class:Ae(["alumni-info",{"mobile-alumni-info":v.value}])},[l("p",null,[e[18]||(e[18]=l("strong",null,"学号：",-1)),u(m(t.alumniId),1)]),l("p",null,[e[19]||(e[19]=l("strong",null,"姓名：",-1)),u(m(t.chineseName||t.firstName+" "+t.lastName),1)]),l("p",null,[e[20]||(e[20]=l("strong",null,"邮箱：",-1)),u(m(t.email),1)]),t.ycywSchoolsAttended?(r(),c("p",Ge,[e[21]||(e[21]=l("strong",null,"就读学校：",-1)),u(m(t.ycywSchoolsAttended),1)])):h("",!0),t.yearLeft?(r(),c("p",He,[e[22]||(e[22]=l("strong",null,"毕业年份：",-1)),u(m(t.yearLeft),1)])):h("",!0)],2)]),l("div",Qe,[l("div",Xe,[l("p",null,[e[23]||(e[23]=l("strong",null,"收件人：",-1)),u(m(t.email),1)]),l("p",null,[e[24]||(e[24]=l("strong",null,"主题：",-1)),u(m(t.subject),1)])]),l("div",Ye,[l("div",Ze,m(t.content),1)])])]))),128)),e[25]||(e[25]=l("div",{class:"preview-footer"},[l("p",null,[l("strong",null,"注意："),u("以上是变量替换后的个性化内容，每位校友将收到针对其个人信息的定制邮件。")])],-1))]))])):h("",!0),p.value===3?(r(),c("div",el,[e[29]||(e[29]=l("h3",null,"确认发送",-1)),l("div",ll,[l("p",null,[e[27]||(e[27]=u("即将向 ")),l("strong",null,m(w.value.length),1),e[28]||(e[28]=u(" 位校友发送邮件"))]),l("p",null,"邮件主题："+m((Z=i.value)==null?void 0:Z.theme),1),a(f,{type:"primary",onClick:ve,loading:j.value,class:"send-btn"},{default:s(()=>[u(m(j.value?"发送中...":"确认发送"),1)]),_:1},8,["loading"])])])):h("",!0),l("div",tl,[l("div",al,[p.value>0?(r(),E(f,{key:0,onClick:_e,class:"action-btn"},{default:s(()=>e[30]||(e[30]=[u(" 上一步 ")])),_:1,__:[30]})):h("",!0),p.value<3?(r(),E(f,{key:1,type:"primary",onClick:pe,disabled:!ae.value,class:"action-btn"},{default:s(()=>e[31]||(e[31]=[u(" 下一步 ")])),_:1,__:[31]},8,["disabled"])):h("",!0)])])])}}},il=Se(nl,[["__scopeId","data-v-02c2a89f"]]);export{il as default};
