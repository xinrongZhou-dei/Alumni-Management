import{_ as ce,u as me,a as pe,r as w,K as _e,c as T,o as fe,b as U,D as ve,A as ge,d as u,e as i,p as c,w as l,g as t,h as G,i as ye,j as v,k as r,l as g,t as p,f as M,M as be,z as y}from"./index-fee6fb78.js";import"./browser-image-compression-946acf20.js";const we={class:"activity-info-list"},qe={class:"info-item"},Ne={class:"info-value"},he={class:"info-item"},ke={class:"info-value"},Ve={class:"info-item"},Ie={class:"info-value"},Ae={class:"info-item"},De={class:"info-value"},Se={class:"info-item"},Ue={class:"info-item"},Fe={class:"info-item"},Pe={key:1,style:{color:"#aaa"}},xe={class:"info-item"},Me={class:"info-value"},Ce={class:"activity-detail-section"},Le={class:"activity-detail-content-text"},Te={class:"card-header"},Be={class:"header-title"},Ee={class:"form-section"},Re={key:0,class:"form-section"},ze={key:1,class:"form-section"},$e={class:"form-actions"},Oe={key:1,class:"registration-status"},je={class:"signup-time"},Je={__name:"AlumniActivityDetail",setup(We){const H=me(),B=pe(),o=w({}),Q=w(null),q=w(!1),E=w(null),R=w(JSON.parse(sessionStorage.getItem("user_info")||"{}")),s=w({salutation:"",firstName:"",lastName:"",chineseName:"",email:"",contactNumber:"",wechatId:"",correspondenceAddress:"",currentLocation:"",companions:0,paymentProof:""});w(null);const X=w(""),Z=async a=>{const e=a.raw||a,_=new FormData;_.append("file",e);try{const m=await U.post("/api/upload/oss",_,{headers:{"Content-Type":"multipart/form-data"}});m.data&&m.data.code===0?(s.value.paymentProof=m.data.url,X.value=m.data.url,y.success("支付凭证上传成功")):y.error(m.data.msg||"支付凭证上传失败")}catch{y.error("支付凭证上传失败")}},h={salutation:[{required:!0,message:"请选择称谓",trigger:"change"}],firstName:[{required:!0,message:"请输入英文名",trigger:"blur"}],lastName:[{required:!0,message:"请输入英文姓",trigger:"blur"}],chineseName:[{required:!0,message:"请输入中文名",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],contactNumber:[{required:!0,message:"请输入联系电话",trigger:"blur"}],wechatId:[],correspondenceAddress:[],currentLocation:[],companions:[],paymentProof:[]};_e(()=>o.value.requiredFields,a=>{a&&(h.wechatId=a.wechat_id_required?[{required:!0,message:"请输入微信ID",trigger:"blur"}]:[],h.correspondenceAddress=a.address_required?[{required:!0,message:"请输入通讯地址",trigger:"blur"}]:[],h.currentLocation=a.current_location_required?[{required:!0,message:"请输入当前位置",trigger:"blur"}]:[],h.companions=a.companions_required?[{required:!0,message:"请输入携带人数",trigger:"change"}]:[],h.paymentProof=a.payment_proof_required?[{required:!0,message:"请上传支付凭证",trigger:"change"}]:[])},{immediate:!0,deep:!0});const N=T(()=>o.value.signupActual>=o.value.signupTotal),ee=T(()=>!q.value&&!k.value&&!N.value),ae=async()=>{try{const a=await U.get("/api/activity/registration",{params:{alumniId:R.value.alumniId,activityUuid:o.value.uuid}});a.data&&a.data.code===0&&a.data.data&&(q.value=!0,E.value=a.data.data,s.value={salutation:a.data.data.salutation,firstName:a.data.data.firstName,lastName:a.data.data.lastName,chineseName:a.data.data.chineseName,email:a.data.data.email,contactNumber:a.data.data.contactNumber,wechatId:a.data.data.wechatId,correspondenceAddress:a.data.data.correspondenceAddress,currentLocation:a.data.data.currentLocation,companions:a.data.data.companions,paymentProof:a.data.data.paymentProof})}catch{}},te=async()=>{if(k.value){y.warning("报名已结束");return}if(N.value){y.warning("报名人数已满");return}try{const a={alumniId:R.value.alumniId,activityUuid:o.value.uuid,salutation:s.value.salutation,firstName:s.value.firstName,lastName:s.value.lastName,chineseName:s.value.chineseName,email:s.value.email,contactNumber:s.value.contactNumber,wechatId:s.value.wechatId,correspondenceAddress:s.value.correspondenceAddress,currentLocation:s.value.currentLocation,companions:s.value.companions,paymentProof:s.value.paymentProof},e=await U.post("/api/activity/signup",a);e.data&&e.data.code===0?(y.success("报名成功"),await C()):y.error(e.data.msg||"报名失败，请稍后重试")}catch(a){a.response&&a.response.data?y.error(a.response.data.msg||"报名失败，请稍后重试"):y.error("报名失败，请稍后重试")}},C=async()=>{const a=await U.get(`/api/activity/detail/${H.params.id}`);a.data&&a.data.code===0&&(o.value=a.data.data,o.value.requiredFields={wechat_id_required:a.data.data.wechat_id_required,address_required:a.data.data.address_required,current_location_required:a.data.data.current_location_required,companions_required:a.data.data.companions_required,payment_proof_required:a.data.data.payment_proof_required},await ae())},F=a=>{if(!a)return"";const e=new Date(a);if(isNaN(e.getTime()))return"";const _=e.getFullYear(),m=String(e.getMonth()+1).padStart(2,"0"),A=String(e.getDate()).padStart(2,"0");return`${_}-${m}-${A}`},le=a=>a==="进行中"?"success":a==="未开始"?"info":a==="即将结束"?"warning":"danger",se=()=>{sessionStorage.getItem("activity_detail_from")==="list"?B.push("/alumni/activity-signup"):B.push("/")},k=T(()=>{if(!o.value.signupEnd)return!1;const a=new Date,e=new Date(o.value.signupEnd);return a>e});fe(async()=>{await C();try{const e=JSON.parse(sessionStorage.getItem("user_info")||"{}").alumniId;if(e){const _=await U.get(`/api/user/info?alumniId=${e}`);_.data&&_.data.code===0&&Object.assign(s.value,_.data.data)}}catch{}oe()});let P=null;function oe(){P=ve({onMessage:a=>{const e=a.data;["activity changed","activity registration changed"].includes(e)&&C()},onClose:()=>{}})}return ge(()=>{P&&P._manualClose&&P._manualClose()}),(a,e)=>{const _=u("el-icon"),m=u("el-button"),A=u("el-divider"),L=u("el-image"),d=u("el-col"),V=u("el-tag"),re=u("el-link"),I=u("el-row"),D=u("el-option"),ne=u("el-select"),f=u("el-form-item"),b=u("el-input"),ie=u("el-input-number"),ue=u("el-upload"),de=u("el-form"),z=u("el-card");return i(),c(z,{class:"activity-detail-root",shadow:"hover"},{default:l(()=>[t(m,{type:"text",onClick:se,class:"back-btn"},{default:l(()=>[t(_,{style:{"vertical-align":"middle","margin-right":"4px"}},{default:l(()=>[t(G(ye))]),_:1}),e[10]||(e[10]=v("返回"))]),_:1,__:[10]}),e[28]||(e[28]=r("div",{class:"activity-detail-header"},[r("div",{class:"activity-detail-title"},"活动详情")],-1)),t(A),t(I,{gutter:32},{default:l(()=>[t(d,{span:10},{default:l(()=>[o.value.coverUrl?(i(),c(L,{key:0,src:o.value.coverUrl,fit:"cover",class:"activity-detail-cover","preview-src-list":[o.value.coverUrl]},null,8,["src","preview-src-list"])):g("",!0)]),_:1}),t(d,{span:14},{default:l(()=>[r("div",we,[r("div",qe,[e[11]||(e[11]=r("span",{class:"info-label"},"活动名称",-1)),r("span",Ne,p(o.value.name),1)]),r("div",he,[e[12]||(e[12]=r("span",{class:"info-label"},"活动日期",-1)),r("span",ke,p(F(o.value.activityDate)),1)]),r("div",Ve,[e[13]||(e[13]=r("span",{class:"info-label"},"报名时间",-1)),r("span",Ie,p(F(o.value.signupStart))+" ~ "+p(F(o.value.signupEnd)),1)]),r("div",Ae,[e[14]||(e[14]=r("span",{class:"info-label"},"报名人数",-1)),r("span",De,p(o.value.signupActual)+" / "+p(o.value.signupTotal),1)]),r("div",Se,[e[15]||(e[15]=r("span",{class:"info-label"},"报名状态",-1)),t(V,{type:le(o.value.signupStatus),effect:"plain"},{default:l(()=>[v(p(o.value.signupStatus),1)]),_:1},8,["type"])]),r("div",Ue,[e[16]||(e[16]=r("span",{class:"info-label"},"活动链接",-1)),t(re,{href:o.value.link,target:"_blank"},{default:l(()=>[v(p(o.value.link),1)]),_:1},8,["href"])]),r("div",Fe,[e[17]||(e[17]=r("span",{class:"info-label"},"活动二维码",-1)),o.value.qrcodeUrl?(i(),c(L,{key:0,src:o.value.qrcodeUrl,fit:"contain",style:{width:"100px",height:"100px"}},null,8,["src"])):(i(),M("span",Pe,"暂无二维码"))]),r("div",xe,[e[18]||(e[18]=r("span",{class:"info-label"},"活动地点",-1)),r("span",Me,p(o.value.venue),1)])])]),_:1})]),_:1}),t(A),r("div",Ce,[e[19]||(e[19]=r("div",{class:"content-label"},"活动详情",-1)),r("div",Le,p(o.value.detail),1)]),t(A),t(z,{class:"form-card"},{header:l(()=>[r("div",Te,[r("span",Be,p(q.value?"报名信息":"报名表"),1),k.value?(i(),c(V,{key:0,type:"danger",effect:"dark",style:{"margin-left":"10px"}},{default:l(()=>e[20]||(e[20]=[v("报名已结束")])),_:1,__:[20]})):g("",!0),N.value?(i(),c(V,{key:1,type:"warning",effect:"dark",style:{"margin-left":"10px"}},{default:l(()=>e[21]||(e[21]=[v("报名人数已满")])),_:1,__:[21]})):g("",!0)])]),default:l(()=>[t(de,{model:s.value,rules:h,ref_key:"signupFormRef",ref:Q,"label-position":"top",disabled:q.value||k.value||N.value,size:"large",class:"signup-form"},{default:l(()=>{var $,O,j,J,W,K;return[r("div",Ee,[t(I,null,{default:l(()=>[t(d,{span:24,sm:8},{default:l(()=>[t(f,{label:"称谓",prop:"salutation"},{default:l(()=>[t(ne,{modelValue:s.value.salutation,"onUpdate:modelValue":e[0]||(e[0]=n=>s.value.salutation=n),placeholder:"请选择称谓",class:"full-width"},{default:l(()=>[t(D,{label:"Prof",value:"Prof"}),t(D,{label:"Dr",value:"Dr"}),t(D,{label:"Mr",value:"Mr"}),t(D,{label:"Mrs",value:"Mrs"}),t(D,{label:"Ms",value:"Ms"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(d,{span:24,sm:8},{default:l(()=>[t(f,{label:"英文名",prop:"firstName"},{default:l(()=>[t(b,{modelValue:s.value.firstName,"onUpdate:modelValue":e[1]||(e[1]=n=>s.value.firstName=n),placeholder:"请输入英文名"},null,8,["modelValue"])]),_:1})]),_:1}),t(d,{span:24,sm:8},{default:l(()=>[t(f,{label:"英文姓",prop:"lastName"},{default:l(()=>[t(b,{modelValue:s.value.lastName,"onUpdate:modelValue":e[2]||(e[2]=n=>s.value.lastName=n),placeholder:"请输入英文姓"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(I,null,{default:l(()=>[t(d,{span:24,sm:8},{default:l(()=>[t(f,{label:"中文名",prop:"chineseName"},{default:l(()=>[t(b,{modelValue:s.value.chineseName,"onUpdate:modelValue":e[3]||(e[3]=n=>s.value.chineseName=n),placeholder:"请输入中文名"},null,8,["modelValue"])]),_:1})]),_:1}),t(d,{span:24,sm:8},{default:l(()=>[t(f,{label:"邮箱",prop:"email"},{default:l(()=>[t(b,{modelValue:s.value.email,"onUpdate:modelValue":e[4]||(e[4]=n=>s.value.email=n),placeholder:"请输入邮箱"},null,8,["modelValue"])]),_:1})]),_:1}),t(d,{span:24,sm:8},{default:l(()=>[t(f,{label:"联系电话",prop:"contactNumber"},{default:l(()=>[t(b,{modelValue:s.value.contactNumber,"onUpdate:modelValue":e[5]||(e[5]=n=>s.value.contactNumber=n),placeholder:"请输入联系电话"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),($=o.value.requiredFields)!=null&&$.wechat_id_required||(O=o.value.requiredFields)!=null&&O.address_required||(j=o.value.requiredFields)!=null&&j.current_location_required||(J=o.value.requiredFields)!=null&&J.companions_required?(i(),M("div",Re,[t(I,null,{default:l(()=>{var n,x,Y;return[(n=o.value.requiredFields)!=null&&n.wechat_id_required?(i(),c(d,{key:0,span:24,sm:8},{default:l(()=>[t(f,{label:"微信ID",prop:"wechatId"},{default:l(()=>[t(b,{modelValue:s.value.wechatId,"onUpdate:modelValue":e[6]||(e[6]=S=>s.value.wechatId=S),placeholder:"请输入微信ID"},null,8,["modelValue"])]),_:1})]),_:1})):g("",!0),(x=o.value.requiredFields)!=null&&x.address_required?(i(),c(d,{key:1,span:24,sm:8},{default:l(()=>[t(f,{label:"通讯地址",prop:"correspondenceAddress"},{default:l(()=>[t(b,{modelValue:s.value.correspondenceAddress,"onUpdate:modelValue":e[7]||(e[7]=S=>s.value.correspondenceAddress=S),placeholder:"请输入通讯地址"},null,8,["modelValue"])]),_:1})]),_:1})):g("",!0),(Y=o.value.requiredFields)!=null&&Y.current_location_required?(i(),c(d,{key:2,span:24,sm:8},{default:l(()=>[t(f,{label:"当前位置",prop:"currentLocation"},{default:l(()=>[t(b,{modelValue:s.value.currentLocation,"onUpdate:modelValue":e[8]||(e[8]=S=>s.value.currentLocation=S),placeholder:"请输入当前位置"},null,8,["modelValue"])]),_:1})]),_:1})):g("",!0)]}),_:1}),t(I,null,{default:l(()=>{var n;return[(n=o.value.requiredFields)!=null&&n.companions_required?(i(),c(d,{key:0,span:24,sm:8},{default:l(()=>[t(f,{label:"携带人数",prop:"companions"},{default:l(()=>[t(ie,{modelValue:s.value.companions,"onUpdate:modelValue":e[9]||(e[9]=x=>s.value.companions=x),min:0,max:10,class:"full-width"},null,8,["modelValue"])]),_:1})]),_:1})):g("",!0)]}),_:1})])):g("",!0),(W=o.value.requiredFields)!=null&&W.payment_proof_required?(i(),M("div",ze,[t(I,null,{default:l(()=>[t(d,{span:24},{default:l(()=>[t(f,{label:"上传凭证",prop:"paymentProof"},{default:l(()=>[t(ue,{class:"upload-demo",action:"#","auto-upload":!1,"show-file-list":!1,"on-change":Z,disabled:q.value||k.value||N.value},{tip:l(()=>e[23]||(e[23]=[r("div",{class:"el-upload__tip"},"请上传支付凭证图片",-1)])),default:l(()=>[t(m,{type:"primary",disabled:q.value||k.value||N.value},{default:l(()=>[t(_,{style:{"vertical-align":"middle","margin-right":"4px"}},{default:l(()=>[t(G(be))]),_:1}),e[22]||(e[22]=v(" 选择文件 "))]),_:1,__:[22]},8,["disabled"])]),_:1},8,["disabled"]),s.value.paymentProof?(i(),c(L,{key:0,src:s.value.paymentProof,fit:"contain",class:"payment-proof-preview","preview-src-list":[s.value.paymentProof]},null,8,["src","preview-src-list"])):g("",!0)]),_:1})]),_:1})]),_:1})])):g("",!0),r("div",$e,[ee.value?(i(),c(m,{key:0,type:"primary",onClick:te},{default:l(()=>e[24]||(e[24]=[v("提交报名")])),_:1,__:[24]})):q.value?(i(),M("div",Oe,[t(V,{type:"success",size:"large"},{default:l(()=>e[25]||(e[25]=[v("已报名")])),_:1,__:[25]}),r("div",je,"报名时间："+p(F((K=E.value)==null?void 0:K.createdAt)),1)])):N.value?(i(),c(V,{key:2,type:"danger",size:"large"},{default:l(()=>e[26]||(e[26]=[v("报名人数已满")])),_:1,__:[26]})):(i(),c(V,{key:3,type:"danger",size:"large"},{default:l(()=>e[27]||(e[27]=[v("报名已结束")])),_:1,__:[27]}))])]}),_:1},8,["model","disabled"])]),_:1})]),_:1,__:[28]})}}},Ge=ce(Je,[["__scopeId","data-v-9189b445"]]);export{Ge as default};
