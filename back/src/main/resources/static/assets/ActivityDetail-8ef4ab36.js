import{_ as Se,u as Ue,a as Fe,r as v,c as R,K as Ce,o as Le,L as x,A as Me,d as c,e as i,p as _,w as l,D as Be,g as a,h as re,i as Ee,j as u,k as n,f as q,l as b,t as r,M as Re,b as Te,z as k,I as $e}from"./index-fee6fb78.js";const ze={class:"activity-detail-header"},Oe={key:0,class:"header-buttons"},Je={class:"activity-info-list"},We={class:"info-item"},je={class:"info-value"},Ke={class:"info-item"},Ye={class:"info-value"},Ge={class:"info-item"},He={class:"info-value"},Qe={class:"info-item"},Xe={class:"info-value"},Ze={class:"info-item"},ea={class:"info-item"},aa={class:"info-item"},ta={key:1,style:{color:"#aaa"}},la={class:"info-item"},sa={class:"info-value"},oa={class:"activity-detail-section"},na={class:"activity-detail-content-text"},ra={class:"card-header"},ia={class:"header-title"},ua={class:"form-section"},da={key:0,class:"form-section"},ca={key:1,class:"form-section"},ma={class:"form-actions"},pa={key:1,class:"registration-status"},va={class:"signup-time"},_a={key:1,class:"activity-detail-section"},fa={class:"search-wrapper"},ga={class:"table-wrapper"},ya={key:1,style:{color:"#aaa","text-align":"center",margin:"16px 0"}},ba={key:1},ha={__name:"ActivityDetail",setup(wa){const ie=Ue(),T=Fe(),o=v({}),C=v([]),P=v(""),ue=v(1),G=v(10),de=v(null),V=v(!1),H=v(null),W=v(!1),d=v(null),j=v(JSON.parse(sessionStorage.getItem("user_info")||"{}")),K=v({}),L=v(0),ce=R(()=>L.value===2),M=R(()=>j.value.role==="admin"),me=async()=>{try{const t=await x.get("/admin/permissions");t.code===0?(K.value=t.data,K.value.activity_management_permission!==void 0?L.value=K.value.activity_management_permission:L.value=0):(console.error("获取权限信息失败:",t.msg),L.value=0)}catch(t){console.error("获取权限信息出错:",t),L.value=0}},s=v({salutation:"",firstName:"",lastName:"",chineseName:"",email:"",contactNumber:"",wechatId:"",correspondenceAddress:"",currentLocation:"",companions:0,paymentProof:""});v(null);const pe=v(""),ve=async t=>{const e=t.raw||t,f=new FormData;f.append("file",e);try{const m=await Te.post("/api/upload/oss",f,{headers:{"Content-Type":"multipart/form-data"}});m.data&&m.data.code===0?(s.value.paymentProof=m.data.url,pe.value=m.data.url,k.success("支付凭证上传成功")):k.error(m.data.msg||"支付凭证上传失败")}catch{k.error("支付凭证上传失败")}},A={salutation:[{required:!0,message:"请选择称谓",trigger:"change"}],firstName:[{required:!0,message:"请输入英文名",trigger:"blur"}],lastName:[{required:!0,message:"请输入英文姓",trigger:"blur"}],chineseName:[{required:!0,message:"请输入中文名",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],contactNumber:[{required:!0,message:"请输入联系电话",trigger:"blur"}],wechatId:[],correspondenceAddress:[],currentLocation:[],companions:[],paymentProof:[]};Ce(()=>o.value.requiredFields,t=>{t&&(A.wechatId=t.wechat_id_required?[{required:!0,message:"请输入微信ID",trigger:"blur"}]:[],A.correspondenceAddress=t.address_required?[{required:!0,message:"请输入通讯地址",trigger:"blur"}]:[],A.currentLocation=t.current_location_required?[{required:!0,message:"请输入当前位置",trigger:"blur"}]:[],A.companions=t.companions_required?[{required:!0,message:"请输入携带人数",trigger:"change"}]:[],A.paymentProof=t.payment_proof_required?[{required:!0,message:"请上传支付凭证",trigger:"change"}]:[])},{immediate:!0,deep:!0});const _e=async()=>{try{const t=await x.get("/activity/registration",{params:{alumniId:j.value.alumniId,activityUuid:o.value.uuid}});t.code===0&&t.data&&(V.value=!0,H.value=t.data,s.value={salutation:t.data.salutation,firstName:t.data.firstName,lastName:t.data.lastName,chineseName:t.data.chineseName,email:t.data.email,contactNumber:t.data.contactNumber,wechatId:t.data.wechatId,correspondenceAddress:t.data.correspondenceAddress,currentLocation:t.data.currentLocation,companions:t.data.companions,paymentProof:t.data.paymentProof})}catch(t){console.error("检查报名状态失败:",t)}},fe=async()=>{if(D.value){k.warning("报名已结束");return}try{const t={alumniId:j.value.alumniId,activityUuid:o.value.uuid,salutation:s.value.salutation,firstName:s.value.firstName,lastName:s.value.lastName,chineseName:s.value.chineseName,email:s.value.email,contactNumber:s.value.contactNumber,wechatId:s.value.wechatId,correspondenceAddress:s.value.correspondenceAddress,currentLocation:s.value.currentLocation,companions:s.value.companions,paymentProof:s.value.paymentProof};await x.post("/activity/signup",t),k.success("报名成功"),await Y()}catch(t){console.error("报名失败:",t),k.error("报名失败，请稍后重试")}},Y=async()=>{const t=await x.get(`/activity/detail/${ie.params.id}`);t.code===0?(o.value=t.data,o.value.requiredFields={wechat_id_required:t.data.wechat_id_required,address_required:t.data.address_required,current_location_required:t.data.current_location_required,companions_required:t.data.companions_required,payment_proof_required:t.data.payment_proof_required},await _e()):console.error("获取活动详情失败",t)},ge=()=>{T.push(`/admin/activity-edit/${o.value.uuid}`)},ye=t=>{$e.confirm("确定要删除该活动吗？此操作不可恢复！","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{const e=await x.delete(`/activity/delete/${t}`);e.data&&e.data.code===0?(k.success("删除成功"),T.push("/admin/activity-manage")):k.error(e.data.msg||"删除失败")}).catch(()=>{})},I=t=>{if(!t)return"";const e=new Date(t);if(isNaN(e.getTime()))return"";const f=e.getFullYear(),m=String(e.getMonth()+1).padStart(2,"0"),S=String(e.getDate()).padStart(2,"0");return`${f}-${m}-${S}`},be=t=>t==="进行中"?"success":t==="未开始"?"info":t==="即将结束"?"warning":"danger",he=R(()=>P.value?C.value.filter(t=>{var e,f,m;return((e=t.chineseName)==null?void 0:e.includes(P.value))||((f=t.firstName)==null?void 0:f.includes(P.value))||((m=t.lastName)==null?void 0:m.includes(P.value))}):C.value),Q=R(()=>{const t=he.value||[],e=(ue.value-1)*G.value;return t.slice(e,e+G.value)}),we=()=>{const e=JSON.parse(sessionStorage.getItem("user_info")||"{}").role==="admin";sessionStorage.getItem("activity_manage_from"),e?T.push("/admin/activity-manage"):T.push("/alumni/activity-manage")},D=R(()=>{if(!o.value.signupEnd)return!1;const t=new Date,e=new Date(o.value.signupEnd);return t>e});let $=null;function Ne(){$=Be({onMessage:t=>{const e=t.data;["activity changed","activity registration changed"].includes(e)&&(Y(),M.value&&X())},onClose:()=>{}})}const X=async()=>{if(!o.value.uuid){console.error("activityUuid 为空，无法获取报名列表");return}try{const t=await x.get("/activity/registrations",{params:{activityUuid:o.value.uuid}});t.code===0?C.value=t.data||[]:C.value=[]}catch(t){C.value=[],console.error("获取报名列表失败:",t)}},qe=t=>{d.value=t,W.value=!0};return Le(async()=>{await me(),await Y(),M.value&&await X();try{const e=JSON.parse(sessionStorage.getItem("user_info")||"{}").alumniId;if(e){const f=await x.get(`/user/info?alumniId=${e}`);f.code===0&&f.data&&Object.assign(s.value,f.data)}}catch{}Ne()}),Me(()=>{$&&$._manualClose&&$._manualClose()}),(t,e)=>{const f=c("el-icon"),m=c("el-button"),S=c("el-divider"),z=c("el-image"),y=c("el-col"),O=c("el-tag"),ke=c("el-link"),U=c("el-row"),B=c("el-option"),Ve=c("el-select"),h=c("el-form-item"),N=c("el-input"),Ie=c("el-input-number"),xe=c("el-upload"),Z=c("el-form"),ee=c("el-card"),F=c("el-table-column"),Pe=c("el-table"),g=c("el-descriptions-item"),Ae=c("el-descriptions"),De=c("el-dialog");return i(),_(ee,{class:"activity-detail-root",shadow:"hover"},{default:l(()=>[a(m,{type:"text",onClick:we,class:"back-btn"},{default:l(()=>[a(f,{style:{"vertical-align":"middle","margin-right":"4px"}},{default:l(()=>[a(re(Ee))]),_:1}),e[13]||(e[13]=u("返回"))]),_:1,__:[13]}),n("div",ze,[e[16]||(e[16]=n("div",{class:"header-left"},[n("h2",{class:"activity-detail-title"},"活动详情")],-1)),M.value&&ce.value?(i(),q("div",Oe,[a(m,{type:"primary",onClick:ge,class:"action-btn"},{default:l(()=>e[14]||(e[14]=[u("编辑活动")])),_:1,__:[14]}),a(m,{type:"danger",onClick:e[0]||(e[0]=w=>ye(o.value.uuid)),class:"action-btn"},{default:l(()=>e[15]||(e[15]=[u("删除活动")])),_:1,__:[15]})])):b("",!0)]),a(S),a(U,{gutter:32,class:"activity-info-row"},{default:l(()=>[a(y,{xs:24,sm:24,md:10,lg:10,xl:10},{default:l(()=>[o.value.coverUrl?(i(),_(z,{key:0,src:o.value.coverUrl,fit:"cover",class:"activity-detail-cover","preview-src-list":[o.value.coverUrl]},null,8,["src","preview-src-list"])):b("",!0)]),_:1}),a(y,{xs:24,sm:24,md:14,lg:14,xl:14},{default:l(()=>[n("div",Je,[n("div",We,[e[17]||(e[17]=n("span",{class:"info-label"},"活动名称",-1)),n("span",je,r(o.value.name),1)]),n("div",Ke,[e[18]||(e[18]=n("span",{class:"info-label"},"活动日期",-1)),n("span",Ye,r(I(o.value.activityDate)),1)]),n("div",Ge,[e[19]||(e[19]=n("span",{class:"info-label"},"报名时间",-1)),n("span",He,r(I(o.value.signupStart))+" ~ "+r(I(o.value.signupEnd)),1)]),n("div",Qe,[e[20]||(e[20]=n("span",{class:"info-label"},"报名人数",-1)),n("span",Xe,r(o.value.signupActual)+" / "+r(o.value.signupTotal),1)]),n("div",Ze,[e[21]||(e[21]=n("span",{class:"info-label"},"报名状态",-1)),a(O,{type:be(o.value.signupStatus),effect:"plain"},{default:l(()=>[u(r(o.value.signupStatus),1)]),_:1},8,["type"])]),n("div",ea,[e[22]||(e[22]=n("span",{class:"info-label"},"活动链接",-1)),a(ke,{href:o.value.link,target:"_blank"},{default:l(()=>[u(r(o.value.link),1)]),_:1},8,["href"])]),n("div",aa,[e[23]||(e[23]=n("span",{class:"info-label"},"活动二维码",-1)),o.value.qrcodeUrl?(i(),_(z,{key:0,src:o.value.qrcodeUrl,fit:"contain",style:{width:"100px",height:"100px"}},null,8,["src"])):(i(),q("span",ta,"暂无二维码"))]),n("div",la,[e[24]||(e[24]=n("span",{class:"info-label"},"活动地点",-1)),n("span",sa,r(o.value.venue),1)])])]),_:1})]),_:1}),a(S),n("div",oa,[e[25]||(e[25]=n("div",{class:"content-label"},"活动详情",-1)),n("div",na,r(o.value.detail),1)]),a(S),a(ee,{class:"form-card"},{header:l(()=>[n("div",ra,[n("span",ia,r(V.value?"报名信息":"报名表"),1),D.value?(i(),_(O,{key:0,type:"danger",effect:"dark",style:{"margin-left":"10px"}},{default:l(()=>e[26]||(e[26]=[u("报名已结束")])),_:1,__:[26]})):b("",!0)])]),default:l(()=>[a(Z,{model:s.value,rules:A,ref_key:"signupFormRef",ref:de,"label-position":"top",disabled:V.value||D.value,size:"large",class:"signup-form"},{default:l(()=>{var w,ae,te,le,se,oe;return[n("div",ua,[a(U,null,{default:l(()=>[a(y,{span:24,sm:8},{default:l(()=>[a(h,{label:"称谓",prop:"salutation"},{default:l(()=>[a(Ve,{modelValue:s.value.salutation,"onUpdate:modelValue":e[1]||(e[1]=p=>s.value.salutation=p),placeholder:"请选择称谓",class:"full-width"},{default:l(()=>[a(B,{label:"Prof",value:"Prof"}),a(B,{label:"Dr",value:"Dr"}),a(B,{label:"Mr",value:"Mr"}),a(B,{label:"Mrs",value:"Mrs"}),a(B,{label:"Ms",value:"Ms"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(y,{span:24,sm:8},{default:l(()=>[a(h,{label:"英文名",prop:"firstName"},{default:l(()=>[a(N,{modelValue:s.value.firstName,"onUpdate:modelValue":e[2]||(e[2]=p=>s.value.firstName=p),placeholder:"请输入英文名"},null,8,["modelValue"])]),_:1})]),_:1}),a(y,{span:24,sm:8},{default:l(()=>[a(h,{label:"英文姓",prop:"lastName"},{default:l(()=>[a(N,{modelValue:s.value.lastName,"onUpdate:modelValue":e[3]||(e[3]=p=>s.value.lastName=p),placeholder:"请输入英文姓"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(U,null,{default:l(()=>[a(y,{span:24,sm:8},{default:l(()=>[a(h,{label:"中文名",prop:"chineseName"},{default:l(()=>[a(N,{modelValue:s.value.chineseName,"onUpdate:modelValue":e[4]||(e[4]=p=>s.value.chineseName=p),placeholder:"请输入中文名"},null,8,["modelValue"])]),_:1})]),_:1}),a(y,{span:24,sm:8},{default:l(()=>[a(h,{label:"邮箱",prop:"email"},{default:l(()=>[a(N,{modelValue:s.value.email,"onUpdate:modelValue":e[5]||(e[5]=p=>s.value.email=p),placeholder:"请输入邮箱"},null,8,["modelValue"])]),_:1})]),_:1}),a(y,{span:24,sm:8},{default:l(()=>[a(h,{label:"联系电话",prop:"contactNumber"},{default:l(()=>[a(N,{modelValue:s.value.contactNumber,"onUpdate:modelValue":e[6]||(e[6]=p=>s.value.contactNumber=p),placeholder:"请输入联系电话"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),(w=o.value.requiredFields)!=null&&w.wechat_id_required||(ae=o.value.requiredFields)!=null&&ae.address_required||(te=o.value.requiredFields)!=null&&te.current_location_required||(le=o.value.requiredFields)!=null&&le.companions_required?(i(),q("div",da,[a(U,null,{default:l(()=>{var p,J,ne;return[(p=o.value.requiredFields)!=null&&p.wechat_id_required?(i(),_(y,{key:0,span:24,sm:8},{default:l(()=>[a(h,{label:"微信ID",prop:"wechatId"},{default:l(()=>[a(N,{modelValue:s.value.wechatId,"onUpdate:modelValue":e[7]||(e[7]=E=>s.value.wechatId=E),placeholder:"请输入微信ID"},null,8,["modelValue"])]),_:1})]),_:1})):b("",!0),(J=o.value.requiredFields)!=null&&J.address_required?(i(),_(y,{key:1,span:24,sm:8},{default:l(()=>[a(h,{label:"通讯地址",prop:"correspondenceAddress"},{default:l(()=>[a(N,{modelValue:s.value.correspondenceAddress,"onUpdate:modelValue":e[8]||(e[8]=E=>s.value.correspondenceAddress=E),placeholder:"请输入通讯地址"},null,8,["modelValue"])]),_:1})]),_:1})):b("",!0),(ne=o.value.requiredFields)!=null&&ne.current_location_required?(i(),_(y,{key:2,span:24,sm:8},{default:l(()=>[a(h,{label:"当前位置",prop:"currentLocation"},{default:l(()=>[a(N,{modelValue:s.value.currentLocation,"onUpdate:modelValue":e[9]||(e[9]=E=>s.value.currentLocation=E),placeholder:"请输入当前位置"},null,8,["modelValue"])]),_:1})]),_:1})):b("",!0)]}),_:1}),a(U,null,{default:l(()=>{var p;return[(p=o.value.requiredFields)!=null&&p.companions_required?(i(),_(y,{key:0,span:24,sm:8},{default:l(()=>[a(h,{label:"携带人数",prop:"companions"},{default:l(()=>[a(Ie,{modelValue:s.value.companions,"onUpdate:modelValue":e[10]||(e[10]=J=>s.value.companions=J),min:0,max:10,class:"full-width"},null,8,["modelValue"])]),_:1})]),_:1})):b("",!0)]}),_:1})])):b("",!0),(se=o.value.requiredFields)!=null&&se.payment_proof_required?(i(),q("div",ca,[a(U,null,{default:l(()=>[a(y,{span:24},{default:l(()=>[a(h,{label:"上传凭证",prop:"paymentProof"},{default:l(()=>[a(xe,{class:"upload-demo",action:"#","auto-upload":!1,"show-file-list":!1,"on-change":ve,disabled:V.value||D.value},{tip:l(()=>e[28]||(e[28]=[n("div",{class:"el-upload__tip"},"请上传支付凭证图片",-1)])),default:l(()=>[a(m,{type:"primary",disabled:V.value||D.value},{default:l(()=>[a(f,{style:{"vertical-align":"middle","margin-right":"4px"}},{default:l(()=>[a(re(Re))]),_:1}),e[27]||(e[27]=u(" 选择文件 "))]),_:1,__:[27]},8,["disabled"])]),_:1},8,["disabled"]),s.value.paymentProof?(i(),_(z,{key:0,src:s.value.paymentProof,fit:"contain",class:"payment-proof-preview","preview-src-list":[s.value.paymentProof]},null,8,["src","preview-src-list"])):b("",!0)]),_:1})]),_:1})]),_:1})])):b("",!0),n("div",ma,[!V.value&&!D.value?(i(),_(m,{key:0,type:"primary",onClick:fe},{default:l(()=>e[29]||(e[29]=[u("提交报名")])),_:1,__:[29]})):V.value?(i(),q("div",pa,[a(O,{type:"success",size:"large"},{default:l(()=>e[30]||(e[30]=[u("已报名")])),_:1,__:[30]}),n("div",va,"报名时间："+r(I((oe=H.value)==null?void 0:oe.createdAt)),1)])):(i(),_(O,{key:2,type:"danger",size:"large"},{default:l(()=>e[31]||(e[31]=[u("报名已结束")])),_:1,__:[31]}))])]}),_:1},8,["model","disabled"])]),_:1}),M.value?(i(),_(S,{key:0})):b("",!0),M.value?(i(),q("div",_a,[e[32]||(e[32]=n("div",{class:"content-label"},"报名人员列表",-1)),n("div",fa,[a(Z,{inline:!0,class:"search-bar"},{default:l(()=>[a(h,null,{default:l(()=>[a(N,{modelValue:P.value,"onUpdate:modelValue":e[11]||(e[11]=w=>P.value=w),placeholder:"请输入姓名搜索",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),n("div",ga,[Q.value.length?(i(),_(Pe,{key:0,data:Q.value,style:{width:"100%","margin-bottom":"16px"},onRowClick:qe},{default:l(()=>[a(F,{prop:"chineseName",label:"中文姓名"}),a(F,{prop:"firstName",label:"英文名"}),a(F,{prop:"lastName",label:"英文姓"}),a(F,{prop:"email",label:"邮箱"}),a(F,{prop:"contactNumber",label:"联系电话"}),a(F,{prop:"createdAt",label:"报名时间",formatter:w=>I(w.createdAt)},null,8,["formatter"])]),_:1},8,["data"])):(i(),q("div",ya,"暂无报名数据"))])])):b("",!0),a(De,{modelValue:W.value,"onUpdate:modelValue":e[12]||(e[12]=w=>W.value=w),title:"报名信息详情",width:"500px"},{default:l(()=>[d.value?(i(),_(Ae,{key:0,column:1,border:""},{default:l(()=>[a(g,{label:"校友ID"},{default:l(()=>[u(r(d.value.alumniId),1)]),_:1}),a(g,{label:"称谓"},{default:l(()=>[u(r(d.value.salutation),1)]),_:1}),a(g,{label:"英文名"},{default:l(()=>[u(r(d.value.firstName),1)]),_:1}),a(g,{label:"英文姓"},{default:l(()=>[u(r(d.value.lastName),1)]),_:1}),a(g,{label:"中文名"},{default:l(()=>[u(r(d.value.chineseName),1)]),_:1}),a(g,{label:"邮箱"},{default:l(()=>[u(r(d.value.email),1)]),_:1}),a(g,{label:"联系电话"},{default:l(()=>[u(r(d.value.contactNumber),1)]),_:1}),a(g,{label:"微信ID"},{default:l(()=>[u(r(d.value.wechatId),1)]),_:1}),a(g,{label:"通讯地址"},{default:l(()=>[u(r(d.value.correspondenceAddress),1)]),_:1}),a(g,{label:"当前位置"},{default:l(()=>[u(r(d.value.currentLocation),1)]),_:1}),a(g,{label:"携带人数"},{default:l(()=>[u(r(d.value.companions),1)]),_:1}),a(g,{label:"支付凭证"},{default:l(()=>{var w;return[d.value&&d.value.paymentProof&&d.value.paymentProof.startsWith("http")?(i(),_(z,{key:0,src:d.value.paymentProof,style:{"max-width":"200px","max-height":"200px"},fit:"contain","preview-src-list":[d.value.paymentProof]},null,8,["src","preview-src-list"])):(i(),q("span",ba,r(((w=d.value)==null?void 0:w.paymentProof)||"无"),1))]}),_:1}),a(g,{label:"报名时间"},{default:l(()=>[u(r(I(d.value.createdAt)),1)]),_:1}),a(g,{label:"更新时间"},{default:l(()=>[u(r(I(d.value.updatedAt)),1)]),_:1})]),_:1})):b("",!0)]),_:1},8,["modelValue"])]),_:1})}}},qa=Se(ha,[["__scopeId","data-v-ad0ef959"]]);export{qa as default};
