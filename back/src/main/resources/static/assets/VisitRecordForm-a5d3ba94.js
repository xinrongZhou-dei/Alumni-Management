import{_ as j,u as Q,a as K,r as _,o as Z,Z as X,d as m,e as b,f as V,g as a,w as l,z as g,b as D,D as $,h as N,i as ee,j as Y,k as f,F as w,m as x,p as U,a1 as ae,l as T,a2 as le}from"./index-fee6fb78.js";const te={class:"visit-record-form"},se={class:"form-section"},oe={class:"form-section"},ue={class:"form-actions"},ne={__name:"VisitRecordForm",setup(re){Q();const S=K(),I=_(JSON.parse(sessionStorage.getItem("user_info")||"{}")),i=_({name:"",studentId:"",currentLocation:"",phone:""}),u=_({campus:"",date:"",timeSlot:"",remarks:""}),n=_(!1),t=_(null),h=_(!1),W={campus:[{required:!0,message:"请选择校区",trigger:"change"}],date:[{required:!0,message:"请选择日期",trigger:"change"}],timeSlot:[{required:!0,message:"请选择时间段",trigger:"change"}],remarks:[{required:!0,message:"请输入备注信息",trigger:"blur"}]},G=[{value:"YCIS_HK",label:"YCIS Hong Kong - 耀中国际学校（香港）"},{value:"YCIS_BJ",label:"YCIS Beijing - 耀中国际学校（北京）"},{value:"YCIS_CQ",label:"YCIS Chongqing - 耀中国际学校（重庆）"},{value:"YCIS_QD",label:"YCIS Qingdao - 耀中国际学校（青岛）"},{value:"YCIS_SH",label:"YCIS Shanghai - 耀中国际学校（上海）"},{value:"YWIES_BJ",label:"YWIES Beijing - 耀华国际教育学校（北京）"},{value:"YWIES_GZ",label:"YWIES Guangzhou - 耀华国际教育学校（广州）"},{value:"YWIES_SH_GB",label:"YWIES Shanghai Gubei - 耀华国际教育学校（上海古北）"},{value:"YWIES_SH_LG",label:"YWIES Shanghai Lingang - 耀华国际教育学校（上海临港）"},{value:"YWIES_TX",label:"YWIES Tongxiang - 耀华国际教育学校（桐乡）"},{value:"YWIES_YT",label:"YWIES Yantai - 耀华国际教育学校（烟台）"}],L=[{value:"MORNING",label:"上午 (9:00-11:30)"},{value:"AFTERNOON",label:"下午 (13:30-16:00)"}],R=o=>{const e=new Date;e.setHours(0,0,0,0);const r=new Date(e);r.setDate(r.getDate()+1);const d=new Date(e);return d.setDate(d.getDate()+7),o.getTime()<r.getTime()||o.getTime()>d.getTime()},B=()=>{h.value?S.push("/alumni/visit-records"):S.push("/")},F=async()=>{try{if(!I.value.alumniId){g.error("未获取到用户信息，请重新登录"),S.push("/login");return}const o=await D.get("/api/user/info",{params:{alumniId:I.value.alumniId}});o.data.code===0?i.value={name:o.data.data.chineseName,studentId:I.value.alumniId,currentLocation:o.data.data.currentLocation,phone:o.data.data.contactNumber}:g.error(o.data.msg||"获取校友信息失败")}catch(o){console.error("获取校友信息失败:",o),g.error("获取校友信息失败")}},O=()=>{const o=sessionStorage.getItem("visit_record");o&&(t.value=JSON.parse(o),n.value=!0,h.value=!0,u.value={campus:t.value.visitSchool,date:t.value.visitDay,timeSlot:t.value.visitTime,remarks:t.value.remark},sessionStorage.removeItem("visit_record"))},P=async()=>{try{const o=sessionStorage.getItem("alumni_token");let e=I.value.alumniId;if(o)try{const v=JSON.parse(atob(o.split(".")[1]));v.alumni_id&&(e=v.alumni_id)}catch(v){console.warn("解析token失败，使用默认alumniId:",v)}const r={alumniId:e,chineseName:i.value.name,currentLocation:i.value.currentLocation,contactNumber:i.value.phone,visitSchool:u.value.campus,visitDay:u.value.date,visitTime:u.value.timeSlot,remark:u.value.remarks};console.log("提交的数据:",r);let d;n.value?d=await D.put(`/api/visitrecord/alumni/visit-records/${t.value.visitUUID}`,r):d=await D.post("/api/visitrecord/alumni/visit-records",r),d.data.code===0?(g.success(n.value?"更新成功":"预约成功"),S.push("/alumni/visit-records")):g.error(d.data.msg||(n.value?"更新失败":"预约失败"))}catch(o){console.error(n.value?"更新失败:":"预约失败:",o),g.error(n.value?"更新失败":"预约失败")}},M=()=>{n.value&&t.value?u.value={campus:t.value.visitSchool,date:t.value.visitDay,timeSlot:t.value.visitTime,remarks:t.value.remark}:u.value={campus:"",date:"",timeSlot:"",remarks:""}},k=_(null),z=o=>{var r;const e=JSON.parse(o.data);e.type==="VISIT_RECORD_UPDATED"&&n.value&&e.payload.visitUUID===((r=t.value)==null?void 0:r.visitUUID)&&(t.value=e.payload,u.value={campus:e.payload.visitSchool,date:e.payload.visitDay,timeSlot:e.payload.visitTime,remarks:e.payload.remark})};function H(){k.value=$({onMessage:z,onClose:()=>{}})}return Z(()=>{F(),O(),H()}),X(()=>{k.value&&k.value._manualClose&&k.value._manualClose()}),(o,e)=>{const r=m("el-icon"),d=m("el-button"),v=m("el-input"),c=m("el-form-item"),p=m("el-col"),y=m("el-row"),E=m("el-option"),C=m("el-select"),J=m("el-date-picker"),q=m("el-form"),A=m("el-card");return b(),V("div",te,[a(d,{type:"text",onClick:B,style:{position:"absolute",left:"24px",top:"24px","font-size":"18px"}},{default:l(()=>[a(r,{style:{"vertical-align":"middle","margin-right":"4px"}},{default:l(()=>[a(N(ee))]),_:1}),e[8]||(e[8]=Y("返回 "))]),_:1,__:[8]}),a(A,{class:"form-card"},{header:l(()=>e[9]||(e[9]=[f("div",{class:"card-header"},[f("span",null,"预约参观校园")],-1)])),default:l(()=>[a(q,{ref:"formRef",model:u.value,rules:W,"label-width":"120px",class:"visit-form",size:"large",disabled:n.value&&t.value&&t.value.status!=="PENDING"},{default:l(()=>[f("div",se,[e[10]||(e[10]=f("div",{class:"section-title"},"校友信息",-1)),a(y,{gutter:20},{default:l(()=>[a(p,{span:12},{default:l(()=>[a(c,{label:"校友姓名"},{default:l(()=>[a(v,{modelValue:i.value.name,"onUpdate:modelValue":e[0]||(e[0]=s=>i.value.name=s),disabled:"",class:"disabled-input"},null,8,["modelValue"])]),_:1})]),_:1}),a(p,{span:12},{default:l(()=>[a(c,{label:"学号"},{default:l(()=>[a(v,{modelValue:i.value.studentId,"onUpdate:modelValue":e[1]||(e[1]=s=>i.value.studentId=s),disabled:"",class:"disabled-input"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(y,{gutter:20},{default:l(()=>[a(p,{span:12},{default:l(()=>[a(c,{label:"当前所在地"},{default:l(()=>[a(v,{modelValue:i.value.currentLocation,"onUpdate:modelValue":e[2]||(e[2]=s=>i.value.currentLocation=s),disabled:"",class:"disabled-input"},null,8,["modelValue"])]),_:1})]),_:1}),a(p,{span:12},{default:l(()=>[a(c,{label:"联系方式"},{default:l(()=>[a(v,{modelValue:i.value.phone,"onUpdate:modelValue":e[3]||(e[3]=s=>i.value.phone=s),disabled:"",class:"disabled-input"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),f("div",oe,[e[11]||(e[11]=f("div",{class:"section-title"},"预约信息",-1)),a(y,{gutter:20},{default:l(()=>[a(p,{span:12},{default:l(()=>[a(c,{label:"预约校区",prop:"campus"},{default:l(()=>[a(C,{modelValue:u.value.campus,"onUpdate:modelValue":e[4]||(e[4]=s=>u.value.campus=s),placeholder:"请选择校区",class:"full-width",disabled:n.value&&t.value&&t.value.status!=="PENDING"},{default:l(()=>[(b(),V(w,null,x(G,s=>a(E,{key:s.value,label:s.label,value:s.value},null,8,["label","value"])),64))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1}),a(p,{span:12},{default:l(()=>[a(c,{label:"预约日期",prop:"date"},{default:l(()=>[a(J,{modelValue:u.value.date,"onUpdate:modelValue":e[5]||(e[5]=s=>u.value.date=s),type:"date",placeholder:"请选择日期","disabled-date":R,"value-format":"YYYY-MM-DD",class:"full-width",disabled:n.value&&t.value&&t.value.status!=="PENDING"},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),a(y,{gutter:20},{default:l(()=>[a(p,{span:12},{default:l(()=>[a(c,{label:"预约时段",prop:"timeSlot"},{default:l(()=>[a(C,{modelValue:u.value.timeSlot,"onUpdate:modelValue":e[6]||(e[6]=s=>u.value.timeSlot=s),placeholder:"请选择时段",class:"full-width",disabled:n.value&&t.value&&t.value.status!=="PENDING"},{default:l(()=>[(b(),V(w,null,x(L,s=>a(E,{key:s.value,label:s.label,value:s.value},null,8,["label","value"])),64))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),a(c,{label:"备注信息",prop:"remarks"},{default:l(()=>[a(v,{modelValue:u.value.remarks,"onUpdate:modelValue":e[7]||(e[7]=s=>u.value.remarks=s),type:"textarea",rows:4,placeholder:"请输入备注信息",class:"full-width",disabled:n.value&&t.value&&t.value.status!=="PENDING"},null,8,["modelValue","disabled"])]),_:1})]),f("div",ue,[!n.value||t.value&&t.value.status==="PENDING"?(b(),U(d,{key:0,type:"primary",onClick:P,size:"large"},{default:l(()=>[a(r,{style:{"vertical-align":"middle","margin-right":"4px"}},{default:l(()=>[a(N(ae))]),_:1}),e[12]||(e[12]=Y(" 提交预约 "))]),_:1,__:[12]})):T("",!0),!n.value||t.value&&t.value.status==="PENDING"?(b(),U(d,{key:1,onClick:M,size:"large"},{default:l(()=>[a(r,{style:{"vertical-align":"middle","margin-right":"4px"}},{default:l(()=>[a(N(le))]),_:1}),e[13]||(e[13]=Y(" 重置 "))]),_:1,__:[13]})):T("",!0)])]),_:1},8,["model","disabled"])]),_:1})])}}},de=j(ne,[["__scopeId","data-v-f1d5cc4f"]]);export{de as default};
